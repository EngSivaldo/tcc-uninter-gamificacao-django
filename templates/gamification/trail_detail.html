{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-16 animate-fadeIn"
     x-data="smartPlayer()"
     x-init="boot({% if user.is_plus %}true{% else %}false{% endif %})">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        <div class="lg:col-span-2 space-y-12">
            <div class="bg-dark-800 rounded-[3.5rem] p-10 border border-white/5 shadow-2xl">
                <h1 class="text-5xl font-black text-white italic uppercase leading-none">{{ trail.title }}</h1>
            </div>

            <div class="space-y-4">
                {% for chapter in chapters %}
                <div @click="launch('{{ chapter.video_url|escapejs }}', '{{ chapter.title|escapejs }}')"
                     class="group bg-dark-800 p-8 rounded-[2.5rem] border border-white/5 hover:border-neon transition-all cursor-pointer">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-6">
                            <span class="text-slate-600 font-black text-2xl group-hover:text-neon">{{ forloop.counter|stringformat:"02d" }}</span>
                            <h3 class="text-xl font-black text-white uppercase italic">{{ chapter.title }}</h3>
                        </div>
                        <div class="bg-dark-950 text-neon px-6 py-3 rounded-xl text-[10px] font-black uppercase border border-neon/10">Assistir</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="sticky top-24 bg-white rounded-[3.5rem] p-10 shadow-2xl space-y-8 text-dark-950 text-center">
                <div class="text-5xl font-black tracking-tighter">R$ 119,90</div>
                <a href="{% url 'gamification:checkout' %}" class="block w-full bg-dark-950 text-white py-6 rounded-2xl font-black uppercase italic shadow-xl">Assinar Plus</a>
            </div>
        </div>
    </div>

    <template x-teleport="body">
        <div x-show="isOpen" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 md:p-10" x-cloak>
            <div class="absolute inset-0 bg-dark-950/98 backdrop-blur-3xl" @click="kill()"></div>
            
            <div class="relative bg-dark-800 w-full max-w-5xl rounded-[3rem] overflow-hidden shadow-2xl border border-white/10"
                 x-show="isOpen" x-transition.scale.95>
                
                <div class="p-8 border-b border-white/5 flex justify-between items-center bg-dark-700/30">
                    <h3 class="text-2xl font-black text-white uppercase italic" x-text="videoTitle"></h3>
                    <button @click="kill()" class="text-slate-500 hover:text-white transition-all"><i class="fas fa-times-circle text-4xl"></i></button>
                </div>
    
                <div class="aspect-video bg-black shadow-inner overflow-hidden relative">
                    <div id="youtube-player-container" class="w-full h-full" x-show="!isLocked"></div>
    
                    <div x-show="isLocked" 
                         x-transition.opacity.duration.500ms
                         class="absolute inset-0 bg-dark-900/90 backdrop-blur-xl flex flex-col items-center justify-center text-center p-8">
                        
                        <div class="w-20 h-20 bg-neon/10 rounded-full flex items-center justify-center mb-6 border border-neon/20 shadow-[0_0_30px_rgba(0,255,157,0.2)]">
                            <i class="fas fa-lock text-neon text-4xl animate-bounce"></i>
                        </div>
                        
                        <h4 class="text-3xl font-black text-white uppercase italic mb-2">Gostou da aula?</h4>
                        <p class="text-slate-400 max-w-md mb-8">
                            Esta Ã© apenas uma amostra gratuita. Assine o <span class="text-neon font-bold">Plano Plus</span> e tenha acesso imediato a todas as aulas, materiais de apoio e certificado!
                        </p>
    
                        <div class="flex flex-col md:flex-row gap-4">
                            <a href="{% url 'gamification:checkout' %}" 
                               class="bg-neon text-dark-900 px-10 py-4 rounded-2xl font-black uppercase italic hover:scale-105 transition-all shadow-[0_10px_40px_rgba(0,255,157,0.3)]">
                                Liberar Acesso Completo
                            </a>
                            <button @click="kill()" class="text-slate-500 hover:text-white uppercase text-xs font-black tracking-widest">
                                Talvez mais tarde
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
    let ytPlayer = null;
    
    function smartPlayer() {
        return {
            isOpen: false,
            isLocked: false, // âœ… Nova variÃ¡vel para controlar a tela de bloqueio
            videoTitle: '',
            isPlus: false,
            timer: null,
    
            boot(status) {
                this.isPlus = status;
                console.log("ðŸš€ Motor Ready. Status Plus:", this.isPlus);
            },
    
            extractId(url) {
                if (!url || url === 'None') return null;
                const match = String(url).match(/(?:v=|\/|be\/|embed\/)([a-zA-Z0-9_-]{11})/);
                return match ? match[1] : null;
            },
    
            launch(url, title) {
                const videoId = this.extractId(url);
                if (!videoId) return alert("VÃ­deo invÃ¡lido.");
    
                this.videoTitle = title;
                this.isOpen = true;
                this.isLocked = false; // Garante que comeÃ§a desbloqueado
                document.body.style.overflow = 'hidden';
    
                setTimeout(() => {
                    if (ytPlayer && ytPlayer.destroy) ytPlayer.destroy();
    
                    ytPlayer = new YT.Player('youtube-player-container', {
                        height: '100%', width: '100%', videoId: videoId,
                        playerVars: { 'autoplay': 1, 'modestbranding': 1, 'rel': 0, 'enablejsapi': 1, 'origin': window.location.origin },
                        events: { 'onReady': (event) => event.target.playVideo() }
                    });
                }, 200);
    
                if (!this.isPlus) {
                    if (this.timer) clearTimeout(this.timer);
                    this.timer = setTimeout(() => {
                        if (this.isOpen) {
                            this.isLocked = true; // âœ… Exibe a mensagem estilizada
                            if (ytPlayer && ytPlayer.destroy) {
                                ytPlayer.destroy();
                                ytPlayer = null;
                            }
                            console.log("ðŸ”’ Preview expirado. Tela de bloqueio ativa.");
                        }
                    }, 30000);
                }
            },
    
            kill() {
                if (ytPlayer && ytPlayer.destroy) ytPlayer.destroy();
                ytPlayer = null;
                this.isOpen = false;
                this.isLocked = false;
                document.body.style.overflow = 'auto';
                if (this.timer) clearTimeout(this.timer);
            }
        }
    }
    </script>

<style>
    [x-cloak] { display: none !important; }
    #youtube-player-container { pointer-events: auto; }
</style>
{% endblock %}