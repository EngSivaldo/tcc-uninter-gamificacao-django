{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-16 animate-fadeIn"
     x-data="smartPlayer()"
     x-init="boot({% if user.is_plus %}true{% else %}false{% endif %})">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">

        <div class="lg:col-span-2 space-y-12">
            
            <div class="bg-dark-800 rounded-[3.5rem] p-10 border border-white/5 shadow-2xl relative overflow-hidden">
                <div class="absolute -top-24 -left-24 w-64 h-64 bg-neon/10 blur-[100px] rounded-full"></div>
                <a href="/" class="relative z-10 text-neon text-xs font-black uppercase tracking-widest flex items-center gap-2 mb-4">
                    <i class="fas fa-arrow-left"></i> Cat√°logo de Forma√ß√µes
                </a>
                <h1 class="relative z-10 text-5xl font-black text-white italic uppercase leading-tight">
                    {{ trail.title }}
                </h1>
                <p class="relative z-10 text-slate-400 mt-4 max-w-xl font-medium italic">
                    {{ trail.description }}
                </p>
            </div>

            {% if user.is_authenticated %}
            <div class="bg-dark-800 rounded-[3rem] p-10 border border-white/5 shadow-2xl">
                <div class="flex justify-between items-end mb-6">
                    <div class="space-y-1">
                        <span class="text-slate-500 text-[10px] font-black uppercase tracking-widest italic">Sincronia com a Trilha</span>
                        <h2 class="text-2xl font-black text-white uppercase italic leading-none">Seu Progresso</h2>
                    </div>
                    <span class="text-5xl font-black text-white italic tracking-tighter">
                        {{ progress|floatformat:0 }}<span class="text-neon text-xl">%</span>
                    </span>
                </div>
                <div class="w-full bg-dark-950 h-10 rounded-full p-2 border border-white/5 shadow-inner">
                    <div class="bg-gradient-to-r from-accent to-neon h-full rounded-full transition-all duration-1000 shadow-[0_0_20px_rgba(0,255,157,0.3)]"
                         style="width: {{ progress|floatformat:0 }}%;"></div>
                </div>
            </div>
            {% endif %}

            <div class="space-y-6">
                <div class="flex items-center gap-4 ml-6 mb-8">
                    <div class="w-2 h-8 bg-neon rounded-full"></div>
                    <h2 class="text-xs font-black uppercase tracking-[0.4em] text-slate-500 italic">Grade Curricular da Unidade</h2>
                </div>

                {% for chapter in chapters %}
                <div class="group bg-dark-800 p-8 rounded-[2.5rem] border transition-all duration-300 shadow-xl relative overflow-hidden
                            {% if chapter.is_completed %} border-neon/20 {% elif not chapter.unlocked %} opacity-60 border-transparent {% else %} border-white/5 hover:border-neon/40 {% endif %}">
                    
                    <div class="absolute inset-0 bg-gradient-to-r from-neon/0 to-neon/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>

                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 relative z-10">
                        <div class="flex items-center gap-6">
                            <span class="text-3xl font-black italic transition-colors 
                                        {% if chapter.is_completed %} text-neon {% else %} text-slate-700 group-hover:text-neon {% endif %}">
                                {{ forloop.counter|stringformat:"02d" }}
                            </span>
                            <div>
                                <h3 class="text-xl font-black text-white uppercase italic leading-none">
                                    {{ chapter.title }}
                                </h3>
                                <div class="flex items-center gap-4 mt-3">
                                    <button @click="launch('{{ chapter.video_url|escapejs }}', '{{ chapter.title|escapejs }}')"
                                            class="text-neon text-[9px] font-black uppercase tracking-widest flex items-center gap-2 hover:brightness-125 transition-all">
                                        <i class="fas fa-play-circle animate-pulse"></i> Assistir Preview
                                    </button>
                                    
                                    {% if chapter.is_premium %}
                                    <span class="text-[9px] font-black text-accent uppercase tracking-widest bg-accent/10 px-2 py-0.5 rounded">
                                        <i class="fas fa-gem mr-1"></i> Plus
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            {% if chapter.is_completed %}
                            <a href="{% url 'gamification:chapter_detail' chapter.id %}" 
                            class="bg-neon/10 border border-neon/30 text-neon px-8 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest flex items-center gap-2 hover:bg-neon hover:text-dark-950 transition-all shadow-[0_0_20px_rgba(0,255,157,0.1)]">
                             <i class="fas fa-check-double"></i> 
                             Conclu√≠do (Revisar)
                         </a>
                            
                            {% elif not chapter.unlocked %}
                                <div class="bg-dark-950/50 px-8 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest text-slate-600 border border-white/5 flex items-center gap-2">
                                    <i class="fas fa-lock"></i> Bloqueado
                                </div>

                            {% elif chapter.is_premium and not user.is_plus %}
                                <a href="{% url 'gamification:checkout' %}" 
                                   class="bg-accent text-dark-950 px-8 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:scale-105 transition-all shadow-lg flex items-center gap-2">
                                    <i class="fas fa-unlock"></i> Liberar Plus
                                </a>

                            {% else %}
                                <a href="{% url 'gamification:chapter_detail' chapter.id %}"
                                   class="bg-white text-dark-950 px-10 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-neon transition-all shadow-lg flex items-center gap-2">
                                    <i class="fas fa-graduation-cap"></i> Estudar Aula
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-slate-500 italic ml-6">Nenhuma aula dispon√≠vel nesta trilha.</p>
                {% endfor %}
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="sticky top-24 bg-white rounded-[4rem] overflow-hidden shadow-[0_30px_100px_rgba(0,0,0,0.5)] p-2 border-8 border-white">
                
                <div class="aspect-video bg-dark-900 rounded-[3rem] overflow-hidden relative group">
                    {% if trail.image %}
                        <img src="{{ trail.image.url }}" class="w-full h-full object-cover opacity-80">
                    {% endif %}
                    <div class="absolute inset-0 flex items-center justify-center bg-black/20">
                        <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-dark-950 shadow-2xl">
                            <i class="fas fa-play ml-1"></i>
                        </div>
                    </div>
                </div>
        
                <div class="p-10">
                    {% if not user.is_plus %}
                        <div class="space-y-8 animate-fadeIn">
                            <div class="space-y-1">
                                <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest italic">Acesso Vital√≠cio</span>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-5xl font-black text-dark-950 italic tracking-tighter">R$ 119,90</span>
                                    <span class="line-through text-slate-400 font-bold text-sm">R$ 497,00</span>
                                </div>
                            </div>
        
                            <ul class="space-y-4">
                                <li class="flex items-center gap-3 text-xs font-bold text-dark-900 italic">
                                    <i class="fas fa-check-circle text-neon"></i> Certificado de Especialista
                                </li>
                                <li class="flex items-center gap-3 text-xs font-bold text-dark-900 italic">
                                    <i class="fas fa-headset text-neon"></i> Suporte Polo UNINTER
                                </li>
                            </ul>
        
                            <a href="{% url 'gamification:checkout' %}"
                               class="block w-full bg-dark-950 text-white py-6 rounded-[2rem] font-black text-center uppercase italic hover:bg-neon hover:text-dark-950 transition-all shadow-xl text-lg tracking-tighter">
                                Desbloquear Arsenal Plus
                            </a>
                        </div>
                    {% else %}
                        <div class="space-y-8 animate-fadeIn">
                            <div class="inline-block bg-brand-neon/10 border border-brand-neon/20 px-4 py-1 rounded-full">
                                <span class="text-brand-neon text-[9px] font-black uppercase tracking-[0.2em]">Assinatura Ativa</span>
                            </div>
                            
                            <h3 class="text-2xl font-black text-dark-950 uppercase italic leading-none">
                                Voc√™ √© <span class="text-brand-blue">Plus!</span>
                            </h3>
        
                            <div class="bg-slate-50 rounded-3xl p-6 space-y-4 border border-slate-100">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Recursos Liberados</p>
                                <ul class="space-y-3">
                                    <li class="flex items-center gap-3 text-xs font-bold text-slate-700">
                                        <div class="w-6 h-6 rounded-lg bg-white shadow-sm flex items-center justify-center text-brand-blue">
                                            <i class="fas fa-file-pdf"></i>
                                        </div>
                                        Apostila em PDF
                                    </li>
                                    <li class="flex items-center gap-3 text-xs font-bold text-slate-700">
                                        <div class="w-6 h-6 rounded-lg bg-white shadow-sm flex items-center justify-center text-brand-blue">
                                            <i class="fas fa-certificate"></i>
                                        </div>
                                        Certificado Dispon√≠vel
                                    </li>
                                </ul>
                            </div>
        
                            <button class="w-full py-4 border-2 border-dark-950 rounded-2xl text-dark-950 font-black uppercase italic text-[10px] tracking-widest hover:bg-dark-950 hover:text-white transition-all">
                                Falar com Mentor
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <template x-teleport="body">
        <div x-show="isOpen" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 md:p-10" x-cloak>
            <div class="absolute inset-0 bg-dark-950/98 backdrop-blur-3xl" @click="kill()"></div>
            
            <div class="relative bg-dark-800 w-full max-w-5xl rounded-[3rem] md:rounded-[4rem] overflow-hidden shadow-2xl border border-white/10"
                 x-show="isOpen" x-transition.scale.95>
                
                <div class="p-8 border-b border-white/5 flex justify-between items-center bg-dark-700/30">
                    <div>
                        <p class="text-neon text-[10px] uppercase font-black tracking-widest italic">Visualizando Amostra Gratuita</p>
                        <h3 class="text-2xl font-black text-white uppercase italic leading-none mt-1" x-text="videoTitle"></h3>
                    </div>
                    <button @click="kill()" class="text-slate-500 hover:text-white transition-all"><i class="fas fa-times-circle text-4xl"></i></button>
                </div>

                <div class="aspect-video bg-black shadow-inner overflow-hidden relative">
                    <div id="youtube-player-container" class="w-full h-full" x-show="!isLocked"></div>

                    <div x-show="isLocked" 
                         x-transition.opacity.duration.500ms
                         class="absolute inset-0 bg-dark-950/95 backdrop-blur-2xl flex flex-col items-center justify-center text-center p-12">
                        
                        <div class="w-24 h-24 bg-neon/10 rounded-full flex items-center justify-center mb-8 border border-neon/20 shadow-[0_0_50px_rgba(0,255,157,0.2)]">
                            <i class="fas fa-lock text-neon text-5xl animate-bounce"></i>
                        </div>
                        
                        <h4 class="text-4xl font-black text-white uppercase italic mb-4 tracking-tighter">Upgrade Necess√°rio</h4>
                        <p class="text-slate-400 max-w-md mb-10 text-lg font-medium italic">
                            O tempo de amostra expirou. Assine o <span class="text-neon font-black">Gamifica Plus</span> para ter acesso vital√≠cio e certificados!
                        </p>

                        <div class="flex flex-col md:flex-row gap-6">
                            <a href="{% url 'gamification:checkout' %}" 
                               class="bg-neon text-dark-900 px-12 py-5 rounded-3xl font-black uppercase italic hover:scale-105 transition-all shadow-[0_15px_50px_rgba(0,255,157,0.3)] text-lg">
                                Desbloquear Agora
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let ytPlayer = null;

function smartPlayer() {
    return {
        isOpen: false,
        isLocked: false,
        videoTitle: '',
        isPlus: false,
        timer: null,

        boot(status) {
            this.isPlus = status;
            console.log("üöÄ SmartPlayer Inicializado. Plus:", this.isPlus);
        },

        extractId(url) {
            if (!url || url === 'None') return null;
            const match = String(url).match(/(?:v=|\/|be\/|embed\/)([a-zA-Z0-9_-]{11})/);
            return match ? match[1] : null;
        },

        launch(url, title) {
            const videoId = this.extractId(url);
            if (!videoId) return alert("V√≠deo n√£o configurado para esta aula.");

            this.videoTitle = title;
            this.isOpen = true;
            this.isLocked = false;
            document.body.style.overflow = 'hidden';

            setTimeout(() => {
                if (ytPlayer && ytPlayer.destroy) ytPlayer.destroy();

                ytPlayer = new YT.Player('youtube-player-container', {
                    height: '100%', width: '100%', videoId: videoId,
                    playerVars: { 
                        'autoplay': 1, 
                        'modestbranding': 1, 
                        'rel': 0, 
                        'enablejsapi': 1, 
                        'origin': window.location.origin 
                    },
                    events: { 'onReady': (event) => event.target.playVideo() }
                });
            }, 300);

            if (!this.isPlus) {
                if (this.timer) clearTimeout(this.timer);
                this.timer = setTimeout(() => {
                    if (this.isOpen) {
                        this.isLocked = true;
                        if (ytPlayer && ytPlayer.destroy) {
                            ytPlayer.destroy();
                            ytPlayer = null;
                        }
                    }
                }, 30000); // 30 segundos
            }
        },

        kill() {
            if (ytPlayer && ytPlayer.destroy) ytPlayer.destroy();
            ytPlayer = null;
            this.isOpen = false;
            this.isLocked = false;
            document.body.style.overflow = 'auto';
            if (this.timer) clearTimeout(this.timer);
        }
    }
}
</script>

<style>
    [x-cloak] { display: none !important; }
    .animate-fadeIn { animation: fadeIn .8s cubic-bezier(.2,.8,.2,1); }
    @keyframes fadeIn { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
</style>
{% endblock %}